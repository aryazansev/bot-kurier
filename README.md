# Bot Kurier

Telegram бот для курьеров, интегрированный с RetailCRM.

## Исправленные проблемы

1. **Обновлена библиотека pyTelegramBotAPI** с версии 3.7.7 до 4.23.0
2. **Добавлены таймауты** для API запросов (10 секунд)
3. **Добавлена обработка ошибок** во всех обработчиках
4. **Добавлена защита от бесконечных циклов** при получении заказов (макс. 10 страниц)
5. **Добавлен retry механизм** для HTTP запросов
6. **Улучшена обработка polling** с автоматическим переподключением

## Локальный запуск

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Создайте файл `.env` и заполните переменные окружения:
```bash
cp .env.example .env
```

3. Запустите бота:
```bash
python main.py
```

## Деплой на Render

### Вариант 1: Через Blueprint (рекомендуется)

1. Запушьте код в GitHub/GitLab репозиторий
2. Зайдите на [Render Dashboard](https://dashboard.render.com/)
3. Нажмите **New +** → **Blueprint**
4. Выберите ваш репозиторий
5. Render автоматически создаст сервис на основе `render.yaml`
6. Добавьте переменные окружения в настройках сервиса:
   - `TG_TOKEN` - токен Telegram бота
   - `RETAIL_URL` - URL RetailCRM (например: https://your-domain.retailcrm.ru)
   - `RETAIL_KEY` - API ключ RetailCRM

### Вариант 2: Вручную

1. Запушьте код в GitHub/GitLab репозиторий
2. На Render создайте **New Web Service**
3. Выберите Docker как runtime
4. Укажите репозиторий
5. Добавьте переменные окружения (см. выше)
6. Нажмите **Create Web Service**

## Переменные окружения

| Переменная | Описание |
|------------|----------|
| `TG_TOKEN` | Токен Telegram бота от @BotFather |
| `RETAIL_URL` | URL вашего RetailCRM |
| `RETAIL_KEY` | API ключ RetailCRM |

## Структура проекта

```
bot-kurier/
├── main.py           # Основной файл бота
├── db.py            # Работа с SQLite базой данных
├── utils.py         # Вспомогательные функции
├── requirements.txt # Зависимости Python
├── Dockerfile       # Конфигурация Docker
├── render.yaml      # Конфигурация Render
└── .env.example     # Пример переменных окружения
```

## Команды бота

- `/start` - Начать работу, авторизация по номеру телефона
- `/menu` - Главное меню со списком заказов

## Поддержка

При проблемах с ботом проверьте логи в Render Dashboard → Logs.
